<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Set-up the Active Peer | Couchbase Docs</title>
<link rel="canonical" href="https://ibsoln.github.io/betasites/h2BetaNet/couchbase-lite/2.8/objc/advance/objc-p2psync-websocket-using-active.html">
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Couchbase Lite - this content covers how to set up an active peer to replicate Couchbase Lite database changes using peer-to-peer sync over websockets">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">
<meta name="dcterms.subject" content="couchbase-lite">
<meta name="dcterms.identifier" content="2.8">
<meta name="generator" content="Antora 2.3.3">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">

              <a class="navbar-brand" href="../../../..">
                <img src="../../../../_/img/couchbase-documentation-logo.svg" alt="Couchbase" />
              </a>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/cloud.html">
                      Cloud
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      SDKs
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Tutorials
                      <span class="arrow">
                        <i class="fas fa-arrow-right"></i>
                      </span>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <form class="navbar-item search">
                  <input type="text" placeholder="Search Docs" class="query" id="search-query" />
                  <button type="button" class="search-btn">
                    <i class="fas fa-search"></i>
                  </button>
                </form>
                <div class="parent-site">
                  <a href="https://www.couchbase.com">
                    Couchbase.com
                  </a>
                </div>
                <a class="btn btn-primary try-btn" href="https://www.couchbase.com/downloads">
                  Try Free
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<nav class="nav">
<div class="left-sidebar-menu">
<div class="version-control-box">
<div class="component-frame">
<div class="frame-icon">
<img src="../../../../_/img/server-icon.png" alt="">
</div>
<div class="frame-body">
<h4 class="title"><span class="">p2pBeta/90220</span></h4>
<a class="navbar-item component" href="../../index.html"> <span class="version">2.8</span></a>
</div>
</div>
</div>
<div class="nav-menu">
<ul class="nav-list">
<li class="nav-item " data-depth="0">

<span class="nav-line "  data-depth="0">
<span class="in-toggle" data-depth="0"></span>
<a class="nav-link" href="../../introduction.html">Introduction</a>
</span>
<ul class="nav-list">
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="../../csharp/advance/csharp-p2psync-websocket-using-passive.html">Passive Peer</a>
</span>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="../../csharp/advance/csharp-p2psync-websocket-using-active.html">Active Peer</a>
</span>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-net/api/Couchbase.Lite">API References</a>
</span>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="../../csharp/learn/csharp-p2psync.html">about p2p</a>
</span>
</li>
</ul>
</li>
</ul>
</div>
<a href="#" class="menu-expand-toggle"> <span>Navigation</span> <i class="fas fa-times-circle"></i> <i class="fas fa-chevron-circle-left"></i></a>
</div></nav>
<aside class="toc sidebar">
  <div class="sidebar-box">
      <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/ianbridge/CouchbaseDocs/bau/cbl/modules/objc/pages/advance/objc-p2psync-websocket-using-active.adoc" title="Edit Page" target="_blank" rel="noopener">Edit on GitHub</a></li>
</ul>
</div>
      <div class="toc-menu"></div>
        <div class="is-this-helpful-box">
          <h4> Is this page helpful?</h4>
            <div class="btn-row">
              <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                     <i class="far fa-thumbs-up"></i>
                 Yes

                 </a>
              <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
            </div>
            <div class="any-feedback">
              <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
            </div>
            <div class="dialog-box" id="dialogBox">
              <form>
                  <div class="form-group " id="additionalFeedbackBox">
                    <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

                    <div class="action-btn-row ">
                      <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                       <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                       <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
                    </div>


                  </div>

              </form>

            </div>
      </div>
   </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../index.html">p2pBeta/90220</a></li>
<li class="crumb"><a href="objc-p2psync-websocket-using-active.html">Set-up the Active Peer</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Set-up the Active Peer</h1>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">Enterprise</a></li>
<li class="status"><span>beta -- {release-comments-cbl}</span></li>
</ul>
</div>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Topic Group&#8201;&#8212;&#8201;<em>Peer-to-Peer Synchronization</em><br>
Description&#8201;&#8212;&#8201;<em>Couchbase Lite - this content covers how to set up an active peer to replicate Couchbase Lite database changes using peer-to-peer sync over websockets</em><br>
Abstract&#8201;&#8212;&#8201;<em>How to set up a Replicator to connect with a Listener and replicate changes using peer-to-peer sync</em><br>
Related Content&#8201;&#8212;&#8201;<a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc">API Reference</a>  |  <a href="objc-p2psync-websocket-using-passive.html" class="page">Passive Peer</a>  |  <a href="objc-p2psync-websocket-using-active.html" class="page">Active Peer</a></p>
</div>
</blockquote>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Code Snippets</div>
The code examples are indicative only.
They demonstrate basic concepts and approaches to using a feature.
Use them as inspiration and adapt these examples to best practice when developing applications for your platform.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Enterprise Edition only</div>
This an <a href="https://www.couchbase.com/products/editions">Enterprise Edition</a> feature.
Purchase the <em>Enterprise License</em>, which includes official <a href="https://www.couchbase.com/support-policy">Couchbase Support</a>, to use it in production (see the license and support <a href="https://www.couchbase.com/licensing-and-support-faq">Licensing</a>).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This content provides sample code and configuration examples covering the implementation of <a href="../../refer-glossary.html#peer-to-peer-sync" class="page">Peer-to-Peer Sync</a> over websockets.</p>
</div>
<div class="paragraph">
<p>Specifically it covers the implementation of an <a href="../../refer-glossary.html#active-peer" class="page">Active Peer</a>.
This <em>replicator</em> will initiate connection with a <a href="../../refer-glossary.html#passive-peer" class="page">Passive Peer</a> and participate in the replication of database changes to bring both databases into sync.</p>
</div>
<div class="paragraph">
<p>In this context the <em>active peer</em> (replicator) acts as the <em>client</em>, whilst the <em>passive peer</em> (listener) acts as the <em>server</em>.</p>
</div>
<div class="paragraph">
<p>You will need to initialize and configure a replicator for each Couchbase Lite database instance you want to sync.
<a href="#simple-replication-to-listener">Example 1</a> shows the initialization and configuration process.
Subsequent sections provide additional details and examples for the main configuration options.</p>
</div>
<div id="simple-replication-to-listener" class="exampleblock">
<div class="title">Example 1. Replication configuration and initialization</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/p2psync-websocket.m">// Set listener DB endpoint
NSURL *url = [NSURL URLWithString:@"ws://listener.com:55990/otherDB"];
CBLURLEndpoint *thisListener = [[CBLURLEndpoint alloc] initWithURL:url];

CBLReplicatorConfiguration *thisConfig
  = [[CBLReplicatorConfiguration alloc]
      initWithDatabase:thisDB target:thisListener]; <i class="conum" data-value="1"></i><b>(1)</b>

thisConfig.replicatorType = kCBLReplicatorTypePush;

thisConfig.continuous = YES;

// Configure Server Security -- only accept self-signed certs
thisConfig.acceptOnlySelfSignedServerCertificate = YES; <i class="conum" data-value="2"></i><b>(2)</b>

// Configure Client Security <i class="conum" data-value="3"></i><b>(3)</b>
//  Set Authentication Mode
thisConfig.authenticator = [[CBLBasicAuthenticator alloc] initWithUsername:@"john" password:@"pass"];

/* Optionally set custom conflict resolver call back */
thisConfig.conflictResolver = [[LocalWinConflictResolver alloc] <i class="conum" data-value="4"></i><b>(4)</b>

// Apply configuration settings to the replicator
_thisReplicator = [[CBLReplicator alloc] initWithConfig:thisConfig]; <i class="conum" data-value="5"></i><b>(5)</b>

// Optionally add a change listener
// retain token for use in deletion
id&lt;CBLListenerToken&gt; thisListenerToken
  = [thisReplicator addChangeListener:^(CBLReplicatorChange *thisChange) {
      if (thisChange.status.activity == kCBLReplicatorStopped) {
        NSLog(@"Replication stopped");
        } else {
        NSLog(@"Status: " + thisChange.status.activity);
        };
    }]; <i class="conum" data-value="6"></i><b>(6)</b>
// Run the replicator using the config settings
[thisReplicator start]; <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html">ReplicatorConfiguration</a> class&#8217;s constructor&#8201;&#8212;&#8201;<a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html#/c:objc(cs)CBLReplicatorConfiguration(im)initWithDatabase:target:">-initWithDatabase:target:</a>&#8201;&#8212;&#8201;to initialize the replicator configuration with the local database&#8201;&#8212;&#8201;see also: <a href="#configure-target">[configure-target]</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here we have configured server security to use only self-signed certificates.
By default only CA Certificates are accepted&#8201;&#8212;&#8201;see: <a href="#listener-authentication">[listener-authentication]</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here the we have configured client security to use <em>Basic Authentication</em>.
Other options are available, for example to authenticate using certificates.
To use client certificate based authentication&#8201;&#8212;&#8201;see: <a href="#client-authentication">[client-authentication]</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Handle <a href="#conflict-resolution">[conflict-resolution]</a></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Initialize the replicator with specified configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Register an observer to be notified of changes to the replication status</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Start the replicator</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2>API References</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can find <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc">Objective C API References</a> here.</p>
</div>
</div>
</div>
<div class="sect1">
<h2>Device Discovery</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>This phase is optional:</strong> If the listener is initialized on a well known URL endpoint (for example, a static IP Address or well known DNS address) then you can configure active peers to connect to those.</p>
</div>
<div class="paragraph">
<p>Prior to connecting with a listener you may execute a peer discovery phase to dynamically discover peers.</p>
</div>
<div class="paragraph">
<p>For the active peer this involves browsing-for and selecting the appropriate service using a zero-config protocol such as <em>Bonjour</em>-- see: <a href="https://developer.apple.com/bonjour/" class="bare">https://developer.apple.com/bonjour/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2>Configure Replicator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section: <a href="#configure-target">[configure-target]</a>  |  <a href="#sync-mode">[sync-mode]</a>  |  <a href="#listener-authentication">[listener-authentication]</a>  | <a href="#client-authentication">[client-authentication]</a></p>
</div>
<div class="sect2">
<h3>Configure Target</h3>
<div class="paragraph">
<p>Use the
<a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html">ReplicatorConfiguration</a> class and <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html#/c:objc(cs)CBLReplicatorConfiguration(im)initWithDatabase:target:">-initWithDatabase:target:</a> constructor to initialize the replication configuration.</p>
</div>
<div class="paragraph">
<p>This constructor provides the passive peer&#8217;s database and endpoint details&#8201;&#8212;&#8201;whether pre-configured or gathered during a discovery phase.</p>
</div>
<div class="paragraph">
<p>The required parameters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The local database to be synced.</p>
</li>
<li>
<p>The database URL including the port the listener is listening on.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The URL scheme for web socket URLs uses <code>ws:</code> (non-TLS) or <code>wss:</code> (SSL/TLS) prefixes.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will also need any security credentials provided (for example, user name and password or Cert) for use in the authentication phase of configuration.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Set target and database config properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/p2psync-websocket.m">// Set listener DB endpoint
NSURL *url = [NSURL URLWithString:@"ws://listener.com:55990/otherDB"];
CBLURLEndpoint *thisListener = [[CBLURLEndpoint alloc] initWithURL:url];

CBLReplicatorConfiguration *thisConfig
  = [[CBLReplicatorConfiguration alloc]
      initWithDatabase:thisDB target:thisListener]; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note use of the <code>wss://</code> prefix to ensure TLS encryption (strongly recommended in production).</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3>Sync Mode</h3>
<div class="paragraph">
<p>Use <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html">ReplicatorConfiguration</a></code> class&#8217;s {https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html#/c:objc(cs)CBLReplicatorConfiguration(py)replicatorType[replicatorType] and
<code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html#/c:objc(cs)CBLReplicatorConfiguration(py)continuous)">continuous</a></code> parameters, to tell the replicator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The direction of the replication: <code><strong>pushAndPull</strong></code>; <code>pull</code>; <code>push</code></p>
</li>
<li>
<p>Whether the replicator should:</p>
<div class="ulist">
<ul>
<li>
<p>Stay active indefinitely to replicate changed documents: <code>continuous=true</code></p>
</li>
<li>
<p>Be a one-shot replication of changed documents: <code>continuous=false</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 3. Configure replicator type and mode</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">thisConfig.replicatorType = kCBLReplicatorTypePush;

thisConfig.continuous = YES;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3>Listener Authentication</h3>
<div class="paragraph">
<p>Use <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html">ReplicatorConfiguration</a></code>, with its {url-api-prop-replicator-config-AcceptOnlySelfSignedServerCertificate} parameter, to tell the replicator how to verify TLS server certificates.</p>
</div>
<div class="paragraph">
<p>If {url-api-prop-replicator-config-AcceptOnlySelfSignedServerCertificate} is <code>false</code> (default) then only CA Certificates are accepted.</p>
</div>
<div class="paragraph">
<p>If {url-api-prop-replicator-config-AcceptOnlySelfSignedServerCertificate} is <code>true</code> then only Self-Signed Certificates are accepted.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Set Server TLS security</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_ca-cert"></a>CA Cert</p>
</li>
<li>
<p><a id="tabset1_self-signed-cert"></a>Self Signed Cert</p>
</li>
<li>
<p><a id="tabset1_pinned-certificate"></a>Pinned Certificate</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_ca-cert">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">// Configure Server Security -- only accept CA Certs
thisConfig.acceptOnlySelfSignedServerCertificate = NO; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the default. Only CA Certificates are allowed.
They must be a certificate from a trusted root
Self signed certificates disallowed.</td>
</tr>
</table>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_self-signed-cert">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">    // Configure Server Security -- only accept self-signed certs
    thisConfig.acceptOnlySelfSignedServerCertificate = YES; <i class="conum" data-value="1"></i><b>(1)</b>

// Use serverCertificateVerificationMode set to `.selfSignedCert` to disable cert validation
thisConfig.disableTLS = false
thisConfig.acceptOnlySelfSignedServerCertificate=true</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set this to <code>true</code> to accept any self signed cert.
Any certificates that are not self-signed are rejected.</td>
</tr>
</table>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_pinned-certificate">
<div class="paragraph">
<p>Set the server&#8217;s SSL certificate (perhaps bundled with the app) to be used for validation, including it in the replicator config.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">NSURL *certURL =
  [[NSBundle mainBundle] URLForResource: @"cert" withExtension: @"cer"];
NSData *data =
  [[NSData alloc] initWithContentsOfURL: certURL];
SecCertificateRef certificate =
  SecCertificateCreateWithData(NULL, (__bridge CFDataRef)data);

NSURL *url =
  [NSURL URLWithString:@"ws://localhost:4984/db"];

CBLURLEndpoint *target = [[CBLURLEndpoint alloc] initWithURL: url];

CBLReplicatorConfiguration *thisConfig =
  [[CBLReplicatorConfiguration alloc] initWithDatabase:database
                                      target:target];
thisConfig.pinnedServerCertificate =
  (SecCertificateRef)CFAutorelease(certificate);

thisConfig.acceptOnlySelfSignedServerCertificate=false;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3>Client Authentication</h3>
<div class="paragraph">
<p>Use <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html">ReplicatorConfiguration</a>'s <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html#/c:objc(cs)CBLReplicatorConfiguration(py)authenticator">authenticator</a> method to define the authentication method to the replicator - see <a href="#configuring-client-authentication">Example 6</a>.</p>
</div>
<div class="sect3">
<h4>Basic Authentication</h4>
<div class="paragraph">
<p>Use the <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLBasicAuthenticator.html">BasicAuthenticator</a></code> to provide basic authentication using username and password credentials.</p>
</div>
<div class="paragraph">
<p>For basic authentication the <code>disableTLS</code> configuration setting is ignored.</p>
</div>
<div id="basic-authentication" class="exampleblock">
<div class="title">Example 5. Basic Authentication</div>
<div class="content">
<div class="paragraph">
<p>This example shows basic authentication using user name and password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">//  Set Authentication Mode
thisConfig.authenticator = [[CBLBasicAuthenticator alloc] initWithUsername:@"john" password:@"pass"];</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4>Certificate Authentication</h4>
<div class="paragraph">
<p>Use the <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLClientCertificateAuthenticator.html">ClientCertificateAuthenticator</a></code> to configure the client TLS certificates to be presented to the server, on connection.
This applies only to the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLURLEndpointListener.html">URLEndpointListener</a>.</p>
</div>
<div class="paragraph">
<p>Note that TLS validates a certificate before passing it over for authentication.
If an invalid certificate is detected then control is never passed over, and the connection is denied.
The decision to be made by the authenticator is simply: "do I trust this certificate, or not"?</p>
</div>
<div class="paragraph">
<p>The decision is usually based on the certificate being signed by a source we trust.</p>
</div>
<div class="paragraph">
<p>For certificate authentication the <code>disableTLS</code> configuration setting must be <code>false</code>.</p>
</div>
<div class="paragraph">
<p>With certificates you also have the option to either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use Couchbase Lite&#8217;s convenience API to create self-signed certificates.
The <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLTLSIdentity.html">TLSIdentity</a></code> class provides methods to manage identities.</p>
</li>
<li>
<p>Bring your own certificate.
Our convenience API also gives you the flexibility to bring your own TLS identities, using the <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLTLSIdentity.html#/c:objc(cs)CBLTLSIdentity(cm)importIdentityWithData:password:label:error:">importIdentity(withData:password:label:error:)</a></code> method.</p>
<div class="paragraph">
<p>This makes it easy to bundle PKCS12 certificates with your application.</p>
</div>
</li>
</ul>
</div>
<div id="configuring-client-authentication" class="exampleblock">
<div class="title">Example 6. Client Cert Authentication</div>
<div class="content">
<div class="paragraph">
<p>This example shows client certificate authentication using an identity from secure storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">// USE KEYCHAIN IDENTITY IF EXISTS
// Check if Id exists in keychain. If so use that Id
do {
    if let thisIdentity = try TLSIdentity.identity(withLabel: "doco-sync-server") {
        print("An identity with label : doco-sync-server already exists in keychain")
        return thisIdentity
        }
} catch
  {return nil}
thisAuthenticator.ClientCertificateAuthenticator(identity: thisIdentity )
thisConfig.thisAuthenticator</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2>Initialize Replicator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicator.html">Replicator</a></code> class&#8217;s <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicator.html#/c:objc(cs)CBLReplicator(im)initWithConfig:">initWith(config:)</a> constructor, to initialize the replicator with the configuration you have defined.
You can, optionally, add a change listener (see <a href="#monitor-sync">[monitor-sync]</a>) before starting the replicator running using <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicator.html#/c:objc(cs)CBLReplicator(im)start">start()</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Initialize and run replicator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/p2psync-websocket.m">// Apply configuration settings to the replicator
_thisReplicator = [[CBLReplicator alloc] initWithConfig:thisConfig]; <i class="conum" data-value="1"></i><b>(1)</b>

// Run the replicator using the config settings
[thisReplicator start]; <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2>Monitor Sync</h2>
<div class="sectionbody">
<div class="sect2">
<h3>Change Listeners</h3>
<div class="paragraph">
<p>Use the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicator.html">Replicator</a> class to add a change listener as a callback to the Replicator (<a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicator.html#/c:objc(cs)CBLReplicator(im)addChangeListener:">addChangeListener(_:)</a>)&#8201;&#8212;&#8201;see <a href="#monitor-replication">Example 8</a>.
You will then be asynchronously notified of state changes.
Use this to monitor changes and to inform on sync progress, as shown below; this is an optional step.</p>
</div>
</div>
<div class="sect2">
<h3>Replicator Status</h3>
<div class="paragraph">
<p>You can use the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicator.html">Replicator</a> class&#8217;s <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicator.html#/c:objc(cs)CBLReplicator(py)status">status</a> property to check the replicator status.
That is, whether it is actively transferring data or if it has stopped.</p>
</div>
<div class="paragraph">
<p>Alternatively, use the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorStatus.html">CBLReplicatorStatus</a> class to get status information. The returned <em>ReplicationStatus</em> structure comprises:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorStatus.html#/c:objc(cs)CBLReplicatorStatus(py)activity">activity enum</a>&#8201;&#8212;&#8201;stopped, offline, connecting, idle or busy</p>
</li>
<li>
<p><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorStatus.html#/c:objc(cs)CBLReplicatorStatus(py)progress)">progress enum</a></p>
<div class="ulist">
<ul>
<li>
<p>completed The total number of changes completed</p>
</li>
<li>
<p>total&#8201;&#8212;&#8201;the total number of changes to be processed</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorStatus.html#/c:objc(cs)CBLReplicatorStatus(py)error">error enum</a>&#8201;&#8212;&#8201;the current error, if any</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more on replication status, see: <a href="../learn/objc-replication.html#replication-status" class="page">Replication Status</a></p>
</div>
<div id="monitor-replication" class="exampleblock">
<div class="title">Example 8. Monitor replication</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_adding-a-change-listener"></a>Adding a Change Listener</p>
</li>
<li>
<p><a id="tabset2_using-replicator-status"></a>Using replicator.status</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_adding-a-change-listener">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">// Optionally add a change listener
// retain token for use in deletion
id&lt;CBLListenerToken&gt; thisListenerToken
  = [thisReplicator addChangeListener:^(CBLReplicatorChange *thisChange) {
      if (thisChange.status.activity == kCBLReplicatorStopped) {
        NSLog(@"Replication stopped");
        } else {
        NSLog(@"Status: " + thisChange.status.activity);
        };
    }]; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_using-replicator-status">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">if (thisChange.status.activity == kCBLReplicatorStopped) {
  NSLog(@"Replication stopped");
  } else {
  NSLog(@"Status: " + thisChange.status.activity);
  };</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2>Stop Sync</h2>
<div class="sectionbody">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Stopping the replication is straightforward using the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicator.html#/c:objc(cs)CBLReplicator(im)stop">stop()</a> method.</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 9. Stop replicator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/p2psync-websocket.m">// Remove the change listener
[thisReplicator removeChangeListenerWithToken: thisLstenerToken];

// Stop the replicator
[thisReplicator start];</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you added an optional change listener (see <a href="#monitor-sync">[monitor-sync]</a> for how) you should also remove it using the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicator.html#/c:objc(cs)CBLReplicator(im)removeChangeListenerWithToken">removeChangeListenerWithToken(CBLListenerToken:)</a> method.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2>Conflict Resolution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase Lite&#8217;s default conflict resolution policy is applied&#8201;&#8212;&#8201;see <a href="../learn/objc-conflict.html#automatic-conflict-resolution" class="page">Automatic Conflict Resolution</a>.
To use a different policy, specify a <em>conflict resolver</em> using <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc/Classes/CBLReplicatorConfiguration.html#/c:objc(cs)CBLReplicatorConfiguration(py)conflictResolver">conflictResolver</a>&#8201;&#8212;&#8201;see: <a href="../learn/objc-conflict.html#custom-conflict-resolution" class="page">Custom Conflict Resolution</a>.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_local-wins"></a>Local Wins</p>
</li>
<li>
<p><a id="tabset3_remote-wins"></a>Remote Wins</p>
</li>
<li>
<p><a id="tabset3_merge"></a>Merge</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_local-wins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">@interface LocalWinConflictResolver: NSObject&lt;CBLConflictResolver&gt;
@end

@implementation LocalWinConflictResolver
- (CBLDocument*) resolve: (CBLConflict*)conflict {
    return conflict.localDocument;
}

@end</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_remote-wins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">@interface RemoteWinConflictResolver: NSObject&lt;CBLConflictResolver&gt;
@end

@implementation RemoteWinConflictResolver
- (CBLDocument*) resolve: (CBLConflict*)conflict {
    return conflict.remoteDocument;
}

@end</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_merge">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc">@interface MergeConflictResolver: NSObject&lt;CBLConflictResolver&gt;
@end

@implementation MergeConflictResolver
- (CBLDocument*) resolve: (CBLConflict*)conflict {
    NSDictionary *localDict = conflict.localDocument.toDictionary;
    NSDictionary *remoteDict = conflict.remoteDocument.toDictionary;

    NSMutableDictionary *result = [NSMutableDictionary dictionaryWithDictionary:localDict];
    [result addEntriesFromDictionary:remoteDict];

    return [[CBLMutableDocument alloc] initWithID:conflict.documentID
                                             data:result];
}

@end</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following code snippet shows an example of merging properties from the existing document (<code>current</code>) into the one being saved (<code>new</code>).
In the event of conflicting keys, it will pick the key value from <code>new</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. Merging Document Properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-objc hljs" data-lang="objc" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/objc/examples/code-snippets/SampleCodeTest.m#L1009-L1023">CBLDocument *document = [database documentWithID:@"xyz"];
CBLMutableDocument *mutableDocument = [document toMutable];
[mutableDocument setString:@"apples" forKey:@"name"];

[database saveDocument:mutableDocument
       conflictHandler:^BOOL(CBLMutableDocument *new, CBLDocument *current) {
           NSDictionary *currentDict = current.toDictionary;
           NSDictionary *newDict = new.toDictionary;

           NSMutableDictionary *result = [NSMutableDictionary dictionaryWithDictionary:currentDict];
           [result addEntriesFromDictionary:newDict];
           [new setData: result];
           return YES;
       }
                 error: &amp;error];</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For more on replicator conflict resolution see: <a href="../learn/objc-conflict.html" class="page">Handling Conflicts</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2>Delta Sync</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If delta sync is enabled on the listener, then replication will use delta sync.</p>
</div>
</div>
</div>
<div class="sect1">
<h2>Related Content</h2>
<div class="sectionbody">
<div class="card-row three-column-row">
<div class="sect5 column">
<h6></h6>
<div class="ulist">
<div class="title">How to</div>
<ul>
<li>
<p><a href="objc-p2psync-websocket-using-passive.html" class="page">Passive Peer</a></p>
</li>
<li>
<p><a href="objc-p2psync-websocket-using-active.html" class="page">Active Peer</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6></h6>
<div class="ulist">
<div class="title">Concepts</div>
<ul>
<li>
<p><a href="../learn/objc-p2psync.html" class="page">Peer-to-peer Synchronization</a></p>
</li>
<li>
<p><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-objc">API References</a>
.</p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6></h6>
<div class="ulist">
<div class="title">Community Resources ...</div>
<ul>
<li>
<p><a href="https://forums.couchbase.com/c/mobile/14">Forum</a>  <strong>|</strong>  <a href="https://blog.couchbase.com/">Blog</a>   <strong>|</strong>  <a href="https://docs.couchbase.com/tutorials/index.html">Tutorials</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase_logo_black.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2020 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
