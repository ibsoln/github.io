<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Set-up the Active Peer | Couchbase Docs</title>
<link rel="canonical" href="https://ibsoln.github.io/betasites/h2BetaAndrod/couchbase-lite/2.8/swift/advance/swift-p2psync-websocket-using-active.html">
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Couchbase Lite - this content covers how to set up an active peer to replicate Couchbase Lite database changes using peer-to-peer sync over websockets">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">
<meta name="dcterms.subject" content="couchbase-lite">
<meta name="dcterms.identifier" content="2.8">
<meta name="generator" content="Antora 2.3.3">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">

              <a class="navbar-brand" href="../../../..">
                <img src="../../../../_/img/couchbase-documentation-logo.svg" alt="Couchbase" />
              </a>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../home/cloud.html">
                      Cloud
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      SDKs
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Tutorials
                      <span class="arrow">
                        <i class="fas fa-arrow-right"></i>
                      </span>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <form class="navbar-item search">
                  <input type="text" placeholder="Search Docs" class="query" id="search-query" />
                  <button type="button" class="search-btn">
                    <i class="fas fa-search"></i>
                  </button>
                </form>
                <div class="parent-site">
                  <a href="https://www.couchbase.com">
                    Couchbase.com
                  </a>
                </div>
                <a class="btn btn-primary try-btn" href="https://www.couchbase.com/downloads">
                  Try Free
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<nav class="nav">
<div class="left-sidebar-menu">
<div class="version-control-box">
<div class="component-frame">
<div class="frame-icon">
<img src="../../../../_/img/server-icon.png" alt="">
</div>
<div class="frame-body">
<h4 class="title"><span class="">P2pBeta/81720-1</span></h4>
<a class="navbar-item component" href="../../index.html"> <span class="version">2.8</span></a>
</div>
</div>
</div>
<div class="nav-menu">
<ul class="nav-list">
<li class="nav-item " data-depth="0">

<span class="nav-line "  data-depth="0">
<span class="in-toggle" data-depth="0"></span>
<a class="nav-link" href="../../android/learn/java-android-p2psync.html">Introduction to P2P Sync</a>
</span>
<ul class="nav-list">
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="../../android/advance/java-android-p2psync-websocket-using-passive.html">Passive Peer</a>
</span>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="../../android/advance/java-android-p2psync-websocket-using-active.html">Active Peer</a>
</span>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-android">API References</a>
</span>
</li>
</ul>
</li>
</ul>
</div>
<a href="#" class="menu-expand-toggle"> <span>Navigation</span> <i class="fas fa-times-circle"></i> <i class="fas fa-chevron-circle-left"></i></a>
</div></nav>
<aside class="toc sidebar">
  <div class="sidebar-box">
      <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/ianbridge/CouchbaseDocs/bau/cbl/modules/swift/pages/advance/swift-p2psync-websocket-using-active.adoc" title="Edit Page" target="_blank" rel="noopener">Edit on GitHub</a></li>
</ul>
</div>
      <div class="toc-menu"></div>
        <div class="is-this-helpful-box">
          <h4> Is this page helpful?</h4>
            <div class="btn-row">
              <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                     <i class="far fa-thumbs-up"></i>
                 Yes

                 </a>
              <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
            </div>
            <div class="any-feedback">
              <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
            </div>
            <div class="dialog-box" id="dialogBox">
              <form>
                  <div class="form-group " id="additionalFeedbackBox">
                    <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

                    <div class="action-btn-row ">
                      <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                       <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                       <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
                    </div>


                  </div>

              </form>

            </div>
      </div>
   </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../index.html">P2pBeta/81720-1</a></li>
<li class="crumb"><a href="swift-p2psync-websocket-using-active.html">Set-up the Active Peer</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Set-up the Active Peer</h1>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">Enterprise</a></li>
<li class="status"><span>beta -- H2-CBL 81720-1</span></li>
</ul>
</div>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Topic Group&#8201;&#8212;&#8201;<em>Peer-to-Peer Synchronization</em><br>
Description&#8201;&#8212;&#8201;<em>Couchbase Lite - this content covers how to set up an active peer to replicate Couchbase Lite database changes using peer-to-peer sync over websockets</em><br>
Abstract&#8201;&#8212;&#8201;<em>How to set up a Replicator to connect with a Listener and replicate changes using peer-to-peer sync</em><br>
Related Content&#8201;&#8212;&#8201;<a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift">API Reference</a>  |  <a href="swift-p2psync-websocket-using-passive.html" class="page">Passive Peer</a>  |  <a href="swift-p2psync-websocket-using-active.html" class="page">Active Peer</a></p>
</div>
</blockquote>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Android enablers</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Manifest</dt>
<dd>
<p><strong>Always</strong> include <code>android:usesCleartextTraffic="true"</code> in the manifest.
This allows use of cleartext (un-encrypted) network traffic such as http.</p>
</dd>
<dt class="hdlist1">Threads</dt>
<dd>
<p><strong>Always</strong> use a <strong>background</strong> thread when working with TLS Identities, Listeners and Replicators; do <strong>NOT</strong> use the UI thread.</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Code Snippets</div>
The code examples are indicative only.
They demonstrate basic concepts and approaches to using a feature.
Use them as inspiration and adapt these examples to best practice when developing applications for your platform.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This content provides sample code covering the implementation of peer-to-peer sync over websockets. Specifically it covers the implementation of an <a href="../../refer-glossary.html#active-peer" class="page">Active Peer</a>, that will initiate replication with a <a href="../../refer-glossary.html#passive-peer" class="page">Passive Peer</a>.</p>
</div>
<div class="paragraph">
<p>The code snippet in <a href="#simple-replication-to-listener">Example 1</a> covers the configuration, initialization and replication is expanded upon in subsequent sections in this content.</p>
</div>
<div id="simple-replication-to-listener" class="exampleblock">
<div class="title">Example 1. Simple Replication to Listener</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/swift/examples/code-snippets/p2psync-websocket.swift">let user = "syncuser"
let password = "sync9455"
let cert:SecCertificate?
let passivePeerEndpoint = "10.1.1.12:8920"
let passivePeerPort = "8920"
let passiveDbName = "userdb"
var actDb:Database?
var thisReplicator:Replicator?
var replicatorListener:ListenerToken?


let tgtUrl = URL(string: "wss://10.1.1.12:8092/actDb")!
let targetEndpoint = URLEndpoint(url: tgtUrl)
var config = ReplicatorConfiguration(database: actDb!, target: targetEndpoint) <i class="conum" data-value="1"></i><b>(1)</b>

config.replicatorType = .pushAndPull
config.continuous = true
// serverCertificateVerificationMode=.selfSignedCert effectively disables cert validation
config.serverCertificateVerificationMode = .selfSignedCert <i class="conum" data-value="2"></i><b>(2)</b>

//  Set Authentication Mode
let authenticator = BasicAuthenticator(username: user, password: password) <i class="conum" data-value="3"></i><b>(3)</b>
config.authenticator = authenticator

// Apply configuration settings to the replicator
thisReplicator = Replicator.init( config: config) <i class="conum" data-value="4"></i><b>(4)</b>

// Optionally add a change listener
// add change listener and retain token for use in deletion
let pushPullReplListener:ListenerToken? = thisReplicator?.addChangeListener({ (change) in <i class="conum" data-value="5"></i><b>(5)</b>
  if change.status.activity == .stopped {
      print("Replication stopped")
  }
  else {
      print("Replicator is currently ", thisReplicator?.status.activity)
  }
})

// Run the replicator using the config settings
thisReplicator?.start()  <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>ReplicationConfiguration</code> class&#8217;s <code>init(database:target:)</code> constructor to initialize the replicator configuration with the local database and remote listener endpoint&#8201;&#8212;&#8201;see <a href="#configure-target">Configure Target</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By default only CA Certificates are accepted Self-signed Certificates are disallowed.
The provided certificate must be from a trusted root.
<div class="paragraph">
<p>use {url-api-prop-replicator-config-AcceptOnlySelfSignedServerCertificate}(true) to ONLY accept self-signed certificates.
Validation of the certificate is bypassed&#8201;&#8212;&#8201;see: <a href="#listener-authentication">Listener Authentication</a></p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>authenticator</code> mode is configured to use basic authentication.
Other supported options are <code>ClientCertificateAuthenticator</code> if you want to use client certificate based authentication&#8201;&#8212;&#8201;see: <a href="#client-authentication">Client Authentication</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Handle <a href="#conflict-resolution">Conflict Resolution</a></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Initialize the replicator with specified configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Register an observer to be notified of changes to the replication status</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Start the replicator</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="api-references"><a class="anchor" href="#api-references"></a>API References</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can find <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift">Swift API References</a> here.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="device-discovery"><a class="anchor" href="#device-discovery"></a>Device Discovery</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>This phase is optional:</strong> If the listener is initialized on a well known URL endpoint (for example, a static IP Address or well known DNS address) then you can configure active peers to connect to those.</p>
</div>
<div class="paragraph">
<p>Prior to connecting with a listener you may execute a peer discovery phase to dynamically discover peers.</p>
</div>
<div class="paragraph">
<p>For the active peer this involves browsing-for and selecting the appropriate service using a zero-config protocol such as <em>Network Service Discovery</em>&#8201;&#8212;&#8201;see: <a href="https://developer.android.com/training/connect-devices-wirelessly/nsd" class="bare">https://developer.android.com/training/connect-devices-wirelessly/nsd</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-replicator"><a class="anchor" href="#configure-replicator"></a>Configure Replicator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section: <a href="#configure-target">Configure Target</a>  |  <a href="#sync-mode">Sync Mode</a>  |  <a href="#listener-authentication">Listener Authentication</a>  | <a href="#client-authentication">Client Authentication</a></p>
</div>
<div class="sect2">
<h3 id="configure-target"><a class="anchor" href="#configure-target"></a>Configure Target</h3>
<div class="paragraph">
<p>Use the
<a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/ReplicatorConfiguration.html">ReplicatorConfiguration</a> class and <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/ReplicatorConfiguration.html#/s:18CouchbaseLiteSwift23ReplicatorConfigurationC8database6targetAcA8DatabaseC_AA8Endpoint_ptcfc">init(database:, target:)</a> constructor to initialize the replication configuration.</p>
</div>
<div class="paragraph">
<p>This constructor provides the passive peer&#8217;s database and endpoint details&#8201;&#8212;&#8201;whether pre-configured or gathered during a discovery phase.</p>
</div>
<div class="paragraph">
<p>The required parameters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The local database to be synced.</p>
</li>
<li>
<p>The database URL including the port the listener is listening on.
The URL scheme for web socket URLs uses <code>ws:</code> (non-TLS) or <code>wss:</code> (SSL/TLS) prefixes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will also need any security credentials provided (for example, user name and password or Cert) for use in the authentication phase of configuration.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Set target and database config properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/swift/examples/code-snippets/p2psync-websocket.swift">let tgtUrl = URL(string: "wss://10.1.1.12:8092/actDb")!
let targetEndpoint = URLEndpoint(url: tgtUrl)
var config = ReplicatorConfiguration(database: actDb!, target: targetEndpoint) <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Requires <code>wss://</code> prefix to URI</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sync-mode"><a class="anchor" href="#sync-mode"></a>Sync Mode</h3>
<div class="paragraph">
<p>Use <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/ReplicatorConfiguration.html">ReplicatorConfiguration</a></code> class&#8217;s <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/ReplicatorConfiguration.html#/s:18CouchbaseLiteSwift23ReplicatorConfigurationC14replicatorTypeAA0dG0Ovp">replicatorType</a> and
<code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/ReplicatorConfiguration.html#/s:18CouchbaseLiteSwift23ReplicatorConfigurationC10continuousSbvp">continuous</a></code> parameters, to tell the replicator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The direction of the replication: <code><strong>pushAndPull</strong></code>; <code>pull</code>; <code>push</code></p>
</li>
<li>
<p>Whether the replicator should:</p>
<div class="ulist">
<ul>
<li>
<p>Stay active indefinitely to replicate changed documents: <code>continuous=true</code></p>
</li>
<li>
<p>Be a one-shot replication of changed documents: <code>continuous=false</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 3. Configure replicator type and mode</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift">config.replicatorType = .pushAndPull
config.continuous = true</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="listener-authentication"><a class="anchor" href="#listener-authentication"></a>Listener Authentication</h3>
<div class="paragraph">
<p>Use <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/ReplicatorConfiguration.html">ReplicatorConfiguration</a></code>, with its {url-api-prop-replicator-config-AcceptOnlySelfSignedServerCertificate} parameter, to tell the replicator how to verify TLS server certificates.</p>
</div>
<div class="paragraph">
<p>If setAcceptOnlySelfSignedServerCertificate is <code>false</code> (default) then only CA Certificates are accepted.</p>
</div>
<div class="paragraph">
<p>If setAcceptOnlySelfSignedServerCertificate is <code>true</code> then only Self-Signed  Certificates are accepted.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_ca-cert"></a>CA Cert</p>
</li>
<li>
<p><a id="tabset1_self-signed-cert"></a>Self Signed Cert</p>
</li>
<li>
<p><a id="tabset1_pinned-certificate"></a>Pinned Certificate</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_ca-cert">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift"></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the default. Only CA Certificates are allowed.
They must be a certificate from a trusted root
Self signed certificates disallowed.</td>
</tr>
</table>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_self-signed-cert">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift">// Use serverCertificateVerificationMode set to `.selfSignedCert` to disable cert validation
config.disableTLS = false
config.serverCertificateVerificationMode = .selfSignedCert</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set this to <code>true</code> to accept any self signed cert.
Any certificates that are not self-signed are rejected.</td>
</tr>
</table>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_pinned-certificate">
<div class="paragraph">
<p>Set the server&#8217;s SSL certificate (perhaps bundled with the app) to be used for validation, including it in the replicator config.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift">Work-in-progress. Code snippet coming soon.</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="client-authentication"><a class="anchor" href="#client-authentication"></a>Client Authentication</h3>
<div class="paragraph">
<p>Use <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/ReplicatorConfiguration.html">ReplicatorConfiguration</a>'s <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/ReplicatorConfiguration.html#/s:18CouchbaseLiteSwift23ReplicatorConfigurationC13authenticatorAA13Authenticator_pSgvp">authenticator</a> method to define the authentication method to the replicator - see <a href="#configuring-client-authentication">Example 4</a>.</p>
</div>
<div class="paragraph">
<p>Valid authenticators include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Structs/BasicAuthenticator.html">BasicAuthenticator</a></code> to use basic authentication with the username and password credentials.</p>
</li>
<li>
<p>The <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Structs/ClientCertificateAuthenticator.html">ClientCertificateAuthenticator</a></code> parameter to configure the client TLS certificates to be presented to the server, on connection. This applies only to the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/URLEndpointListener.html">URLEndpointListener</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you are using certificates, you have the option to either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use Couchbase Lite&#8217;s convenience API to create self-signed certificates.
The <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/TLSIdentity.html">TLSIdentity</a></code> class provides methods to manage identities.</p>
</li>
<li>
<p>Bring your own certificate.
Our convenience API also gives you the flexibility to bring your own TLS identities, using the <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/TLSIdentity.html#/s:18CouchbaseLiteSwift11TLSIdentityC14importIdentity8withData8password5labelAC10Foundation0H0V_SSSgSStKFZ">importIdentity(withData:password:label:)</a></code> method.</p>
<div class="paragraph">
<p>This makes it easy to bundle PKCS12 certificates with your application.</p>
</div>
</li>
</ul>
</div>
<div id="configuring-client-authentication" class="exampleblock">
<div class="title">Example 4. Configuring client authentication</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_basic-authentication"></a>Basic Authentication</p>
</li>
<li>
<p><a id="tabset2_client-cert-authentication"></a>Client Cert Authentication</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_basic-authentication">
<div class="paragraph">
<p>This example shows basic authentication using user name and password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift">//  Set Authentication Mode
let authenticator = BasicAuthenticator(username: user, password: password) <i class="conum" data-value="1"></i><b>(1)</b>
config.authenticator = authenticator</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_client-cert-authentication">
<div class="paragraph">
<p>This example shows client certificate authentication using an identity from secure storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift">Work-in-progress. Code snippet coming soon.</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initialize-replicator"><a class="anchor" href="#initialize-replicator"></a>Initialize Replicator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the <code><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator.html/">Replicator</a></code> class&#8217;s <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator.html#/s:18CouchbaseLiteSwift10ReplicatorC6configAcA0D13ConfigurationC_tcfc">init(config:)</a> constructor, to initialize the replicator with the configuration you have defined.
You can, optionally, add a change listener (see <a href="#monitor-sync">Monitor Sync</a>) before starting the replicator running using <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator.html#/s:18CouchbaseLiteSwift10ReplicatorC5startyyF">start()</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Initialize and run replicator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/swift/examples/code-snippets/p2psync-websocket.swift">// Apply configuration settings to the replicator
thisReplicator = Replicator.init( config: config) <i class="conum" data-value="1"></i><b>(1)</b>

// Optionally add a change listener

// Run the replicator using the config settings
thisReplicator?.start()  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="monitor-sync"><a class="anchor" href="#monitor-sync"></a>Monitor Sync</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="change-listeners"><a class="anchor" href="#change-listeners"></a>Change Listeners</h3>
<div class="paragraph">
<p>Use the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator.html/">Replicator</a> class to add a change listener as a callback to the Replicator (<a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator.html#/s:18CouchbaseLiteSwift10ReplicatorC17addChangeListeneryAA0G5TokenCyAA0dF0VcF">addChangeListener(_:)</a>)&#8201;&#8212;&#8201;see <a href="#monitor-replication">Example 6</a>.
You will then be asynchronously notified of state changes.
Use this to monitor changes and to inform on sync progress, as shown below; this is an optional step.</p>
</div>
</div>
<div class="sect2">
<h3 id="replicator-status"><a class="anchor" href="#replicator-status"></a>Replicator Status</h3>
<div class="paragraph">
<p>You can also use <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator.html#/s:18CouchbaseLiteSwift10ReplicatorC6StatusV">status</a> to monitor replicator status.
That is, when it is actively transferring data and when it has stopped.</p>
</div>
<div class="paragraph">
<p>The {url-api-class-replicator-status} structure comprises the following elements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator/ActivityLevel.html">ActivityLevel enum</a>&#8201;&#8212;&#8201;stopped, offline, connecting, idle or busy</p>
</li>
<li>
<p><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator/Progress.html">Progress enum</a></p>
<div class="ulist">
<ul>
<li>
<p>completed The total number of changes completed</p>
</li>
<li>
<p>total&#8201;&#8212;&#8201;the total number of changes to be processed</p>
</li>
</ul>
</div>
</li>
<li>
<p>{url-api-enum-replicator-error}&#8201;&#8212;&#8201;the current error, if any</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more on replication status, see: <a href="../learn/swift-replication.html#replication-status" class="page">Replication Status</a></p>
</div>
<div id="monitor-replication" class="exampleblock">
<div class="title">Example 6. Monitor replication</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_addchangelistener"></a>addChangeListener()</p>
</li>
<li>
<p><a id="tabset3_replicator-status"></a>replicator.status</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_addchangelistener">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/swift/examples/code-snippets/p2psync-websocket.swift">// add change listener and retain token for use in deletion
let pushPullReplListener:ListenerToken? = thisReplicator?.addChangeListener({ (change) in <i class="conum" data-value="1"></i><b>(1)</b>
  if change.status.activity == .stopped {
      print("Replication stopped")
  }
  else {
      print("Replicator is currently ", thisReplicator?.status.activity)
  }
})</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_replicator-status">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/swift/examples/code-snippets/p2psync-websocket.swift">      print("Replicator is currently ", thisReplicator?.status.activity)
  }
})</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stop-sync"><a class="anchor" href="#stop-sync"></a>Stop Sync</h2>
<div class="sectionbody">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Stopping the replication is straightforward using the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator.html#/s:18CouchbaseLiteSwift10ReplicatorC4stopyyF">stop()</a> method.</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 7. Stop replicator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/swift/examples/code-snippets/p2psync-websocket.swift">// Remove the change listener

thisReplicator?.removeChangeListener(withToken: pushPullReplListener)
// Stop the replicator
thisReplicator?.stop()</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you added an optional change listener (see <a href="#monitor-sync">Monitor Sync</a> for how) you should also remove it using the <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/Replicator.html#//s:18CouchbaseLiteSwift10ReplicatorC20removeChangeListener9withTokenyAA0gI0C_tF">removeChangeListener(withToken:)</a> method.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conflict-resolution"><a class="anchor" href="#conflict-resolution"></a>Conflict Resolution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase Lite&#8217;s default conflict resolution policy is applied&#8201;&#8212;&#8201;see <a href="../learn/swift-conflict.html#automatic-conflict-resolution" class="page">Automatic Conflict Resolution</a>.
To use a different policy, specify a <em>conflict resolver</em> using <a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift/Classes/ReplicatorConfiguration.html#/s:18CouchbaseLiteSwift23ReplicatorConfigurationC16conflictResolverAA08ConflictG8Protocol_pSgvp">conflictResolver</a>&#8201;&#8212;&#8201;see: <a href="../learn/swift-conflict.html#custom-conflict-resolution" class="page">Custom Conflict Resolution</a>.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_local-wins"></a>Local Wins</p>
</li>
<li>
<p><a id="tabset4_remote-wins"></a>Remote Wins</p>
</li>
<li>
<p><a id="tabset4_merge"></a>Merge</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_local-wins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift">Using `replConfig.setConflictResolver(new LocalWinConflictResolver());`

class LocalWinConflictResolver: ConflictResolverProtocol {
    func resolve(conflict: Conflict) -&gt; Document? {
        return conflict.localDocument
    }
}</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_remote-wins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift">Using `replConfig.setConflictResolver(new RemoteWinConflictResolver());`

class RemoteWinConflictResolver: ConflictResolverProtocol {
    func resolve(conflict: Conflict) -&gt; Document? {
        return conflict.remoteDocument
    }
}</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_merge">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift">Using `replConfig.setConflictResolver(new MergeConflictResolver());`

class MergeConflictResolver: ConflictResolverProtocol {
    func resolve(conflict: Conflict) -&gt; Document? {
        let localDict = conflict.localDocument!.toDictionary()
        let remoteDict = conflict.remoteDocument!.toDictionary()
        let result = localDict.merging(remoteDict) { (current, new) -&gt; Any in
            return current // return current value in case of duplicate keys
        }
        return MutableDocument(id: conflict.documentID, data: result)
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following code snippet shows an example of merging properties from the existing document (<code>current</code>) into the one being saved (<code>new</code>).
In the event of conflicting keys, it will pick the key value from <code>new</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Merging Document Properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-swift hljs" data-lang="swift" data-source-url="https://github.com/ibsoln/docs-couchbase-lite/blob/undefined/modules/swift/examples/code-snippets/SampleCodeTest.swift#L936-L945">guard let document = database.document(withID: "xyz") else { return }
let mutableDocument = document.toMutable()
mutableDocument.setString("apples", forKey: "name")
try database.saveDocument(mutableDocument, conflictHandler: { (new, current) -&gt; Bool in
    let currentDict = current!.toDictionary()
    let newDict = new.toDictionary()
    let result = newDict.merging(currentDict, uniquingKeysWith: { (first, _) in first })
    new.setData(result)
    return true
})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For more on replicator conflict resolution see: <a href="../learn/swift-conflict.html" class="page">Handling Conflicts</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="delta-sync"><a class="anchor" href="#delta-sync"></a>Delta Sync</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If delta sync is enabled on the listener, then replication will use delta sync.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-content"><a class="anchor" href="#related-content"></a>Related Content</h2>
<div class="sectionbody">
<div class="card-row three-column-row">
<div class="sect5 column">
<h6 id=""><a class="anchor" href="#"></a></h6>
<div class="ulist">
<div class="title">How to</div>
<ul>
<li>
<p><a href="swift-p2psync-websocket-using-passive.html" class="page">Passive Peer</a></p>
</li>
<li>
<p><a href="swift-p2psync-websocket-using-active.html" class="page">Active Peer</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-2"><a class="anchor" href="#-2"></a></h6>
<div class="ulist">
<div class="title">Concepts</div>
<ul>
<li>
<p><a href="../learn/swift-p2psync.html" class="page">Peer-to-peer Synchronization</a></p>
</li>
<li>
<p><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift">API References</a>
.</p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-3"><a class="anchor" href="#-3"></a></h6>
<div class="ulist">
<div class="title">Community Resources ...</div>
<ul>
<li>
<p><a href="https://forums.couchbase.com/c/mobile/14">Forum</a>  <strong>|</strong>  <a href="https://blog.couchbase.com/">Blog</a>   <strong>|</strong>  <a href="https://docs.couchbase.com/tutorials/index.html">Tutorials</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-content-2"><a class="anchor" href="#related-content-2"></a>Related Content</h2>
<div class="sectionbody">
<div class="card-row three-column-row">
<div class="sect5 column">
<h6 id="-4"><a class="anchor" href="#-4"></a></h6>
<div class="ulist">
<div class="title">How to</div>
<ul>
<li>
<p><a href="swift-p2psync-websocket-using-passive.html" class="page">Passive Peer</a></p>
</li>
<li>
<p><a href="swift-p2psync-websocket-using-active.html" class="page">Active Peer</a></p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-5"><a class="anchor" href="#-5"></a></h6>
<div class="ulist">
<div class="title">Concepts</div>
<ul>
<li>
<p><a href="../learn/swift-p2psync.html" class="page">Peer-to-peer Synchronization</a></p>
</li>
<li>
<p><a href="https://ibsoln.github.io/betasites/api/mobile/2.8.0/couchbase-lite-swift">API References</a>
.</p>
</li>
</ul>
</div>
</div>
<div class="sect5 column">
<h6 id="-6"><a class="anchor" href="#-6"></a></h6>
<div class="ulist">
<div class="title">Community Resources ...</div>
<ul>
<li>
<p><a href="https://forums.couchbase.com/c/mobile/14">Forum</a>  <strong>|</strong>  <a href="https://blog.couchbase.com/">Blog</a>   <strong>|</strong>  <a href="https://docs.couchbase.com/tutorials/index.html">Tutorials</a></p>
</li>
</ul>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Enterprise Edition only</div>
This an <a href="https://www.couchbase.com/products/editions">Enterprise Edition</a> feature.
Purchase the <em>Enterprise License</em>, which includes official <a href="https://www.couchbase.com/support-policy">Couchbase Support</a>, to use it in production (see the license and support <a href="https://www.couchbase.com/licensing-and-support-faq">Licensing</a>).
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase_logo_black.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2020 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
