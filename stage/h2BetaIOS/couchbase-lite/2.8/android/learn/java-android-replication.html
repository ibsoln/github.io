<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Working with Replications | Couchbase Docs</title>
<link rel="canonical" href="https://ibsoln.github.io/stage/h2BetaIOS/couchbase-lite/2.8/android/learn/java-android-replication.html">
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">
<meta name="dcterms.subject" content="couchbase-lite">
<meta name="dcterms.identifier" content="2.8">
<meta name="generator" content="Antora 2.3.3">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">

              <a class="navbar-brand" href="../../../..">
                <img src="../../../../_/img/couchbase-documentation-logo.svg" alt="Couchbase" />
              </a>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Cloud
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      SDKs
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Tutorials
                      <span class="arrow">
                        <i class="fas fa-arrow-right"></i>
                      </span>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <form class="navbar-item search">
                  <input type="text" placeholder="Search Docs" class="query" id="search-query" />
                  <button type="button" class="search-btn">
                    <i class="fas fa-search"></i>
                  </button>
                </form>
                <div class="parent-site">
                  <a href="https://www.couchbase.com">
                    Couchbase.com
                  </a>
                </div>
                <a class="btn btn-primary try-btn" href="https://www.couchbase.com/downloads">
                  Try Free
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<nav class="nav">
<div class="left-sidebar-menu">
<div class="version-control-box">
<div class="component-frame">
<div class="frame-icon">
<img src="../../../../_/img/server-icon.png" alt="">
</div>
<div class="frame-body">
<h4 class="title"><span class="">Couchbase Lite (h2Beta-19JUN20)</span></h4>
<a class="navbar-item component" href="../../index.html"> <span class="version">2.8</span></a>
</div>
</div>
</div>
<div class="nav-menu">
<ul class="nav-list">
<li class="nav-item " data-depth="0">

<span class="nav-line "  data-depth="0">
<span class="in-toggle" data-depth="0"></span>
<span class="nav-text ">Swift</span>
</span>
<ul class="nav-list">
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<span class="in-toggle" data-depth="1"></span>
<span class="nav-text ">Start</span>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/start/swift-gs-prereqs.html">Prerequisites</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/start/swift-gs-install.html">Install</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/start/swift-gs-build.html">Test Build</a>
</span>
</li>
</ul>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<span class="in-toggle" data-depth="1"></span>
<span class="nav-text ">Next</span>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/next/swift-dbo-crud.html">Using CRUD Operations</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/next/swift-dbo-query.html">Using Query Operations</a>
</span>
</li>
</ul>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<span class="in-toggle" data-depth="1"></span>
<span class="nav-text ">Advance</span>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<span class="in-toggle" data-depth="2"></span>
<span class="nav-text ">Peer-to-Peer Sync</span>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="3">

<span class="nav-line "  data-depth="3">
<a class="nav-link" href="../../swift/advance/swift-p2psync-websocket-using-passive.html">Deploy Passive Peer</a>
</span>
</li>
<li class="nav-item " data-depth="3">

<span class="nav-line "  data-depth="3">
<a class="nav-link" href="../../swift/advance/swift-p2psync-websocket-using-active.html">Deploy Active Peer</a>
</span>
</li>
<li class="nav-item " data-depth="3">

<span class="nav-line "  data-depth="3">
<a class="nav-link" href="../../swift/advance/swift-p2p-managing-tls-id.html">Manage TLS Identity</a>
</span>
</li>
</ul>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/advance/swift-dep-upgrade.html">Upgrading</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/advance/swift-troubleshooting.html">Troubleshooting</a>
</span>
</li>
</ul>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<span class="in-toggle" data-depth="1"></span>
<span class="nav-text ">Learn</span>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/learn/swift-database.html">Working with Databases</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/learn/swift-document.html">Working with Documents</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/learn/swift-blob.html">Working with Blobs</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<span class="in-toggle" data-depth="2"></span>
<a class="nav-link" href="#couchbase-lite:swift:learn/query/swift-query.adoc">Query the data</a>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="3">

<span class="nav-line "  data-depth="3">
<a class="nav-link" href="#couchbase-lite:swift:learn/query/swift-query-live.adoc">Live Queries</a>
</span>
</li>
<li class="nav-item " data-depth="3">

<span class="nav-line "  data-depth="3">
<a class="nav-link" href="#couchbase-lite:swift:learn/query/swift-query-predictive.adoc">Predictive Queries</a>
</span>
</li>
<li class="nav-item " data-depth="3">

<span class="nav-line "  data-depth="3">
<a class="nav-link" href="../../swift/learn/swift-fts.html">Running Full-text Searches</a>
</span>
</li>
</ul>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/learn/swift-indexing.html">Indexing</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/learn/swift-replication.html">Working with Replications</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/learn/swift-dbreplica.html">Local Replicaton</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/learn/swift-conflict.html">Handling Conflicts</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<span class="in-toggle" data-depth="2"></span>
<a class="nav-link" href="../../swift/learn/swift-p2psync.html">Peer-to_peer Synchronization</a>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="3">

<span class="nav-line "  data-depth="3">
<a class="nav-link" href="../../swift/learn/swift-p2psync-websocket.html">P2P - Websocket</a>
</span>
</li>
<li class="nav-item " data-depth="3">

<span class="nav-line "  data-depth="3">
<a class="nav-link" href="../../swift/learn/swift-p2psync-custom.html">P2P - Custom</a>
</span>
</li>
</ul>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/learn/swift-thread-safety.html">Thread-safety</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/learn/swift-cert-pinning.html">Certificate Pinning</a>
</span>
</li>
</ul>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<span class="in-toggle" data-depth="1"></span>
<span class="nav-text ">Refer</span>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="https://ibsoln.github.io/stage/api/mobile/2.8.0/couchbase-lite-swift">API References</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="#couchbase-lite::{cbl-pg-glossary}">Glossary</a>
</span>
</li>
</ul>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<span class="in-toggle" data-depth="1"></span>
<span class="nav-text ">Product Notes</span>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/product/swift-releasenotes.html">Release Notes</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="#couchbase-lite:swift:product/swift-pn-supportnotes.adoc">Support Notices</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../compatibility.html">Compatibility</a>
</span>
</li>
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../../swift/product/swift-changelog.html">Change Log</a>
</span>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<a href="#" class="menu-expand-toggle"> <span>Navigation</span> <i class="fas fa-times-circle"></i> <i class="fas fa-chevron-circle-left"></i></a>
</div></nav>
<aside class="toc sidebar">
  <div class="sidebar-box">
      <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/ianbridge/CouchbaseDocs/bau/cbl/modules/android/pages/learn/java-android-replication.adoc" title="Edit Page" target="_blank" rel="noopener">Edit on GitHub</a></li>
</ul>
</div>
      <div class="toc-menu"></div>
        <div class="is-this-helpful-box">
          <h4> Is this page helpful?</h4>
            <div class="btn-row">
              <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                     <i class="far fa-thumbs-up"></i>
                 Yes

                 </a>
              <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
            </div>
            <div class="any-feedback">
              <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
            </div>
            <div class="dialog-box" id="dialogBox">
              <form>
                  <div class="form-group " id="additionalFeedbackBox">
                    <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

                    <div class="action-btn-row ">
                      <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                       <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                       <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
                    </div>


                  </div>

              </form>

            </div>
      </div>
   </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../index.html">Couchbase Lite (h2Beta-19JUN20)</a></li>
<li class="crumb"><a href="java-android-replication.html">Working with Replications</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Working with Replications</h1>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">Under Development</a></li>
<li class="status"><span>beta -- H2-CBL as at 29Jun20</span></li>
</ul>
</div>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>ifeval::["beta" =  "gamma"]</p>
</div>
<div class="openblock pane__frame--orange">
<div class="title">Author&#8217;s Notes</div>
<div class="content">
<div class="paragraph">
<p>Refactor and rationalize content as required and-or time permits.</p>
</div>
</div>
</div>
</div>
</div>
<h1 id="replication" class="sect0"><a class="anchor" href="#replication"></a>Replication</h1>
<div class="paragraph">
<p>Unresolved include directive in modules/android/pages/learn/java-android-replication.adoc - include::partial$replication-introduction.adoc[]</p>
</div>
<div class="sect1">
<h2 id="compatibility"><a class="anchor" href="#compatibility"></a>Compatibility</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The new protocol is <strong>incompatible</strong> with CouchDB-based databases.
And since Couchbase Lite 2 only supports the new protocol, you will need to run a version of Sync Gateway that <a href="../../../../sync-gateway/2.7/compatibility-matrix.html" class="page">supports it</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use this protocol with Couchbase Lite 2.0, the replication URL should specify WebSockets as the URL scheme (see the <a href="#starting-a-replication">Starting a Replication</a> section below).
Mobile clients using Couchbase Lite 1.x can continue to use <strong>http</strong> as the URL scheme.
Sync Gateway 2.0 will automatically use the 1.x replication protocol when a Couchbase Lite 1.x client connects through http://localhost:4984/db and the 2.0 replication protocol when a Couchbase Lite 2.0 client connects through "ws://localhost:4984/db".</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="starting-sync-gateway"><a class="anchor" href="#starting-sync-gateway"></a>Starting Sync Gateway</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.couchbase.com/downloads">Download Sync Gateway</a> and start it from the command line with the configuration file created above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">~/Downloads/couchbase-sync-gateway/bin/sync_gateway</code></pre>
</div>
</div>
<div class="paragraph">
<p>For platform specific installation instructions, refer to the Sync Gateway <a href="../../../../sync-gateway/2.7/gs-sgw-install.html#installation" class="page">installation guide</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="starting-a-replication"><a class="anchor" href="#starting-a-replication"></a>Starting a Replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Replication can be bidirectional, this means you can start a <code>push</code>/<code>pull</code> replication with a single instance.
The replication&#8217;s parameters can be specified through the <a href="https://ibsoln.github.io/stage/api/mobile/2.8.0/couchbase-lite-java-android/index.html?com/couchbase/lite/ReplicatorConfiguration.html"><code>ReplicatorConfiguration</code></a> object;
for example, if you wish to start a <code>push</code> only or <code>pull</code> only replication.</p>
</div>
<div class="paragraph">
<p>The following example creates a <code>pull</code> replication with Sync Gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java-android hljs" data-lang="java-android">class MyClass {
    Database database;
    Replicator replicator; <i class="conum" data-value="1"></i><b>(1)</b>

    void startReplication() {
        URI uri = null;
        try {
            uri = new URI("wss://10.0.2.2:4984/db"); <i class="conum" data-value="2"></i><b>(2)</b>
        } catch (URISyntaxException e) {
            e.printStackTrace();
        }
        Endpoint endpoint = new URLEndpoint(uri);
        ReplicatorConfiguration config = new ReplicatorConfiguration(database, endpoint);
        config.setReplicatorType(ReplicatorConfiguration.ReplicatorType.PULL);
        this.replicator = new Replicator(config);
        this.replicator.start();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A replication is an asynchronous operation.
To keep a reference to the <code>replicator</code> object, you can set it as an instance property.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The URL scheme for remote database URLs has changed in Couchbase Lite 2.0.
You should now use <code>ws:</code>, or <code>wss:</code> for SSL/TLS connections.
In this example the hostname is <code>10.0.2.2</code> because the Android emulator runs in a VM that is generally accessible on <code>10.0.2.2</code> from the host machine (see <a href="https://developer.android.com/studio/run/emulator-networking">Android Emulator networking</a> documentation).
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As of Android Pie, version 9, API 28, cleartext support is disabled, by default.
Although <code>wss:</code> protocol URLs are not affected, in order to use the <code>ws:</code> protocol, applications must target API 27 or lower, or must configure application network security as described <a href="https://developer.android.com/training/articles/security-config#CleartextTrafficPermitted">here</a>.
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/android/pages/learn/java-android-replication.adoc - include::partial$verify-replication.adoc[]</p>
</div>
<div class="paragraph">
<p>Couchbase Lite 2.0 uses WebSockets as the communication protocol to transmit data.
Some load balancers are not configured for WebSocket connections by default (NGINX for example);
so it might be necessary to explicitly enable them in the load balancer&#8217;s configuration (see <a href="../../../../sync-gateway/2.7/load-balancer.html" class="page">Load Balancers</a>).</p>
</div>
<div class="paragraph">
<p>By default, the WebSocket protocol uses compression to optimize for speed and bandwidth utilization.
The level of compression is set on Sync Gateway and can be tuned in the configuration file (<a href="../../../../sync-gateway/2.7/config-properties.html#replicator_compression" class="page"><code>replicator_compression</code></a>).</p>
</div>
<div class="sect2">
<h3 id="replication-ordering"><a class="anchor" href="#replication-ordering"></a>Replication Ordering</h3>
<div class="paragraph">
<p>To optimize for speed, the replication protocol doesn&#8217;t guarantee that documents will be received in a particular order.
So we don&#8217;t recommend to rely on that when using the replication or database change listeners for example.</p>
</div>
</div>
<div class="sect2">
<h3 id="replicator-notifications-on-a-custom-executor"><a class="anchor" href="#replicator-notifications-on-a-custom-executor"></a>Replicator Notifications on a Custom Executor</h3>
<div class="paragraph">
<p>Prior to version 2.6, Couchbase Lite spun up multiple executors.
This policy could result in too many threads being spun up.</p>
</div>
<div class="paragraph">
<p>An executor manages a pool of threads and, perhaps, a queue in front of the executor, to handle the asynchronous callbacks.
Couchbase Lite API calls which are processed by an executor are listed below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java-android hljs" data-lang="java-android">Query.addChangeListener
MessageEndpointListerner.addChangeListener
LiveQuery.addChangeListener
AbstractReplicator.addDocumentReplicationListener
AbstractReplicator.addChangeListener
Database.addChangeListener
Database.addDocumentChangeListener
Database.addDatabaseChangeListener
Database.addChangeListener</code></pre>
</div>
</div>
<div class="paragraph">
<p>As of version 2.6, Couchbase sometimes uses its own internal executor to run asynchronous client code.
While this is fine for small tasks, larger tasks&#8201;&#8212;&#8201;those that take significant compute time, or that perform I/O&#8201;&#8212;&#8201;can block Couchbase processing.
If this happens your application will fail with a <code>RejectedExecutionException</code> and it may be necessary to create a separate executor on which to run the large tasks.</p>
</div>
<div class="paragraph">
<p>The following examples show how to specify a separate executor in the client code.
The client code executor can enforce an application policy for delivery ordering and the number of threads.</p>
</div>
<div class="paragraph">
<p><strong>Guaranteed Order Delivery</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
 * This version guarantees in order delivery and is parsimonious with space
 * The listener does not need to be thread safe (at least as far as this code is concerned).
 * It will run on only thread (the Executor's thread) and must return from a given call
 * before the next call commences.  Events may be delivered arbitrarily late, though,
 * depending on how long it takes the listener to run.
 */
public class InOrderExample {
    private static final ExecutorService IN_ORDER_EXEC = Executors.newSingleThreadExecutor();

    public Replicator runReplicator(Database db1, Database db2, ReplicatorChangeListener listener)
        throws CouchbaseLiteException {
        ReplicatorConfiguration config = new ReplicatorConfiguration(db1, new DatabaseEndpoint(db2));
        config.setReplicatorType(ReplicatorConfiguration.ReplicatorType.PUSH_AND_PULL);
        config.setContinuous(false);

        Replicator repl = new Replicator(config);
        ListenerToken token = repl.addChangeListener(IN_ORDER_EXEC, listener::changed);

        repl.start();

        return repl;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Maximum Throughput</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java-android hljs" data-lang="java-android">/**
 * This version maximizes throughput.  It will deliver change notifications as quickly
 * as CPU availability allows. It may deliver change notifications out of order.
 * Listeners must be thread safe because they may be called from multiple threads.
 * In fact, they must be re-entrant because a given listener may be running on mutiple threads
 * simultaneously.  In addition, when notifications swamp the processors, notifications awaiting
 * a processor will be queued as Threads, (instead of as Runnables) with accompanying memory
 * and GC impact.
 */
public class MaxThroughputExample {
    private static final ExecutorService MAX_THROUGHPUT_EXEC = Executors.newCachedThreadPool();

    public Replicator runReplicator(Database db1, Database db2, ReplicatorChangeListener listener)
        throws CouchbaseLiteException {
        ReplicatorConfiguration config = new ReplicatorConfiguration(db1, new DatabaseEndpoint(db2));
        config.setReplicatorType(ReplicatorConfiguration.ReplicatorType.PUSH_AND_PULL);
        config.setContinuous(false);

        Replicator repl = new Replicator(config);
        ListenerToken token = repl.addChangeListener(MAX_THROUGHPUT_EXEC, listener::changed);

        repl.start();

        return repl;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Extreme Configurability</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java-android hljs" data-lang="java-android">/**
 * This version demonstrates the extreme configurability of the CouchBase Lite replicator callback system.
 * It may deliver updates out of order and does require thread-safe and re-entrant listeners
 * (though it does correctly synchronizes tasks passed to it using a SynchronousQueue).
 * The thread pool executor shown here is configured for the sweet spot for number of threads per CPU.
 * In a real system, this single executor might be used by the entire application and be passed to
 * this module, thus establishing a reasonable app-wide threading policy.
 * In an emergency (Rejected Execution) it lazily creates a backup executor with an unbounded queue
 * in front of it.  It, thus, may deliver notifications late, as well as out of order.
 */
public class PolicyExample {
    private static final int CPUS = Runtime.getRuntime().availableProcessors();

    private static ThreadPoolExecutor BACKUP_EXEC;

    private static final RejectedExecutionHandler BACKUP_EXECUTION
        = new RejectedExecutionHandler() {
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            synchronized (this) {
                if (BACKUP_EXEC =  null) { BACKUP_EXEC = createBackupExecutor(); }
            }
            BACKUP_EXEC.execute(r);
        }
    };

    private static ThreadPoolExecutor createBackupExecutor() {
        ThreadPoolExecutor exec
            = new ThreadPoolExecutor(CPUS + 1, 2 * CPUS + 1, 30, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;Runnable&gt;());
        exec.allowCoreThreadTimeOut(true);
        return exec;
    }

    private static final ThreadPoolExecutor STANDARD_EXEC
        = new ThreadPoolExecutor(CPUS + 1, 2 * CPUS + 1, 30, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;());

    static { STANDARD_EXEC.setRejectedExecutionHandler(BACKUP_EXECUTION); }

    public Replicator runReplicator(Database db1, Database db2, ReplicatorChangeListener listener)
        throws CouchbaseLiteException {
        ReplicatorConfiguration config = new ReplicatorConfiguration(db1, new DatabaseEndpoint(db2));
        config.setReplicatorType(ReplicatorConfiguration.ReplicatorType.PUSH_AND_PULL);
        config.setContinuous(false);

        Replicator repl = new Replicator(config);
        ListenerToken token = repl.addChangeListener(STANDARD_EXEC, listener::changed);

        repl.start();

        return repl;
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>Troubleshooting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As always, when there is a problem with replication, logging is your friend.
The following example increases the log output for activity related to replication with Sync Gateway.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java-android hljs" data-lang="java-android">Database.setLogLevel(LogDomain.REPLICATOR, LogLevel.VERBOSE);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentication"><a class="anchor" href="#authentication"></a>Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/android/pages/learn/java-android-replication.adoc - include::partial$authentication.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="replication-status"><a class="anchor" href="#replication-status"></a>Replication Status</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>replication.Status.Activity</code> property can be used to check the status of a replication.
For example, when the replication is actively transferring data and when it has stopped.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java-android hljs" data-lang="java-android">replicator.addChangeListener(change -&gt; {
    if (change.getStatus().getActivityLevel() == Replicator.ActivityLevel.STOPPED) {
        Log.i(TAG, "Replication stopped");
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table lists the different activity levels in the API and the meaning of each one.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">State</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STOPPED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replication is finished or hit a fatal error.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OFFLINE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replicator is offline as the remote host is unreachable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONNECTING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replicator is connecting to the remote host.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IDLE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replication caught up with all the changes available from the server.
The <code>IDLE</code> state is only used in continuous replications.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BUSY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The replication is actively transferring data.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The replication change object also has properties to track the progress (<code>change.status.completed</code> and <code>change.status.total</code>).
But since the replication occurs in batches and the total count can vary through the course of a replication, those progress indicators are not very useful from the standpoint of an app user.
Hence, these should not be used for tracking the actual progress of the replication.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a id="repstatus-and-lifecycle"></a></p>
</div>
<div class="sect2">
<h3 id="replication-status-and-app-lifecycle"><a class="anchor" href="#replication-status-and-app-lifecycle"></a>Replication Status and App Lifecycle</h3>
<div class="paragraph">
<p>Couchbase Lite replications will continue running until the app terminates, unless the remote system, or the application, terminates the connection.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Recall that the Android OS may kill an application without warning.
You should explicitly stop replication processes when they are no longer useful (for example, when they are <code>suspended</code> or <code>idle</code>) to avoid socket connections being closed by the OS, which may interfere with the replication process.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handling-network-errors"><a class="anchor" href="#handling-network-errors"></a>Handling Network Errors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If an error occurs, the replication status will be updated with an <code>Error</code> which follows the standard HTTP error codes.
The following example monitors the replication for errors and logs the error code to the console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java-android hljs" data-lang="java-android">replicator.addChangeListener(change -&gt; {
    CouchbaseLiteException error = change.getStatus().getError();
    if (error != null) { Log.w(TAG, "Error code:: %d", error); }
});
replicator.start();</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a permanent error occurs (i.e., <code>404</code>: not found, <code>401</code>: unauthorized), the replicator (continuous or one-shot) will stop permanently.
If the error is temporary (i.e., waiting for the network to recover), a continuous replication will retry to connect indefinitely and if the replication is one-shot it will retry for a limited number of times.
The following error codes are considered temporary by the Couchbase Lite replicator and thus will trigger a connection retry.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>408</code>: Request Timeout</p>
</li>
<li>
<p><code>429</code>: Too Many Requests</p>
</li>
<li>
<p><code>500</code>: Internal Server Error</p>
</li>
<li>
<p><code>502</code>: Bad Gateway</p>
</li>
<li>
<p><code>503</code>: Service Unavailable</p>
</li>
<li>
<p><code>504</code>: Gateway Timeout</p>
</li>
<li>
<p><code>1001</code>: DNS resolution error</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="replication-events"><a class="anchor" href="#replication-events"></a>Replication Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/android/pages/learn/java-android-replication.adoc - include::partial$replication-events.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom-headers"><a class="anchor" href="#custom-headers"></a>Custom Headers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/android/pages/learn/java-android-replication.adoc - include::partial$replication-custom-header.adoc[]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java-android hljs" data-lang="java-android">ReplicatorConfiguration config = new ReplicatorConfiguration(database, endpoint);
Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();
headers.put("CustomHeaderName", "Value");
config.setHeaders(headers);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="replication-checkpoint-reset"><a class="anchor" href="#replication-checkpoint-reset"></a>Replication Checkpoint Reset</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/android/pages/learn/java-android-replication.adoc - include::partial$replication-checkpoint.adoc[]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java-android hljs" data-lang="java-android">replicator.resetCheckpoint();
replicator.start();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="replication-filters"><a class="anchor" href="#replication-filters"></a>Replication Filters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved include directive in modules/android/pages/learn/java-android-replication.adoc - include::partial$replication-filters.adoc[]</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase_logo_black.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2020 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
