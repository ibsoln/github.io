<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Conflict Resolution in Inter-cluster Replication | Couchbase Docs</title>
<link rel="canonical" href="https://ibsoln.github.io/stage/h2betasgw2-slim/sync-gateway/2.8/learn/icr-conflict-resolution.html">
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="This content covers conflict resolution in inter-cluster replication (replication between Sync Gateway clusters)">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">
<meta name="dcterms.subject" content="sync-gateway">
<meta name="dcterms.identifier" content="2.8">
<meta name="generator" content="Antora 2.3.3">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">

              <a class="navbar-brand" href="../../..">
                <img src="../../../_/img/couchbase-documentation-logo.svg" alt="Couchbase" />
              </a>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Cloud
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      SDKs
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">
                      Tutorials
                      <span class="arrow">
                        <i class="fas fa-arrow-right"></i>
                      </span>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <form class="navbar-item search">
                  <input type="text" placeholder="Search Docs" class="query" id="search-query" />
                  <button type="button" class="search-btn">
                    <i class="fas fa-search"></i>
                  </button>
                </form>
                <div class="parent-site">
                  <a href="https://www.couchbase.com">
                    Couchbase.com
                  </a>
                </div>
                <a class="btn btn-primary try-btn" href="https://www.couchbase.com/downloads">
                  Try Free
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container panes">
<nav class="nav">
<div class="left-sidebar-menu">
<div class="version-control-box">
<div class="component-frame">
<div class="frame-icon">
<img src="../../../_/img/server-icon.png" alt="">
</div>
<div class="frame-body">
<h4 class="title"><span class="">Sync Gateway  H2-BETA 15July20-0800</span></h4>
<a class="navbar-item component" href="icr-overview.html"> <span class="version">2.8</span></a>
</div>
</div>
</div>
<div class="nav-menu">
<div class="main-nav-parent new " data-depth="0">
<span class="back-to-menu"><i class="fas fa-chevron-left"></i> Main Menu </span>
</div>
<ul class="nav-list">
<li class="nav-item is-current-path is-active is-active-depth-2  " data-depth="0">

<span class="nav-line "  data-depth="0">
<span class="in-toggle" data-depth="0"></span>
<span class="nav-text ">Learn</span>
</span>
<ul class="nav-list">
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="icr-overview.html">Inter-Cluster Replication</a>
</span>
</li>
<li class="nav-item is-current-page is-active is-active-depth-2  " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="icr-conflict-resolution.html">Conflict Resolution</a>
</span>
</li>
</ul>
</li>
<li class="nav-item " data-depth="0">

<span class="nav-line "  data-depth="0">
<span class="in-toggle" data-depth="0"></span>
<span class="nav-text ">Refer</span>
</span>
<ul class="nav-list">
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="../refer/config-properties.html">Configuration Schema</a>
</span>
</li>
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<span class="in-toggle" data-depth="1"></span>
<span class="nav-text ">Sync Gateway API</span>
</span>
<ul class="nav-list">
<li class="nav-item " data-depth="2">

<span class="nav-line "  data-depth="2">
<a class="nav-link" href="../refer/rest-api-admin.html">Admin REST API</a>
</span>
</li>
</ul>
</li>
</ul>
</li>
<li class="nav-item " data-depth="0">

<span class="nav-line "  data-depth="0">
<span class="in-toggle" data-depth="0"></span>
<span class="nav-text ">Product Notes</span>
</span>
<ul class="nav-list">
<li class="nav-item  is-inactive " data-depth="1">

<span class="nav-line "  data-depth="1">
<a class="nav-link" href="../prodnotes/pn-change-log-config.html">Configuration Change Log</a>
</span>
</li>
</ul>
</li>
</ul>
</div>
<a href="#" class="menu-expand-toggle"> <span>Navigation</span> <i class="fas fa-times-circle"></i> <i class="fas fa-chevron-circle-left"></i></a>
</div></nav>
<aside class="toc sidebar">
  <div class="sidebar-box">
      <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/ianbridge/CouchbaseDocs/bau/sgw/modules/ROOT/pages/learn/icr-conflict-resolution.adoc" title="Edit Page" target="_blank" rel="noopener">Edit on GitHub</a></li>
</ul>
</div>
      <div class="toc-menu"></div>
        <div class="is-this-helpful-box">
          <h4> Is this page helpful?</h4>
            <div class="btn-row">
              <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                     <i class="far fa-thumbs-up"></i>
                 Yes

                 </a>
              <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
            </div>
            <div class="any-feedback">
              <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
            </div>
            <div class="dialog-box" id="dialogBox">
              <form>
                  <div class="form-group " id="additionalFeedbackBox">
                    <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

                    <div class="action-btn-row ">
                      <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                       <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                       <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
                    </div>


                  </div>

              </form>

            </div>
      </div>
   </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<button class="nav-control"></button>
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="icr-overview.html">Sync Gateway  H2-BETA 15July20-0800</a></li>
<li class="crumb">Learn</li>
<li class="crumb"><a href="icr-conflict-resolution.html">Conflict Resolution</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Conflict Resolution in Inter-cluster Replication</h1>
<div class="labels">
<ul>
<li class="edition"><a href="https://www.couchbase.com/products/editions">Under Development</a></li>
<li class="status"><span>beta -- H2-SGW as at 10Jul20</span></li>
</ul>
</div>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Author&#8217;s Notes</div>
CONTENT UNDER DEVELOPMENT
</td>
</tr>
</table>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>This content covers conflict resolution in inter-cluster replication (replication between Sync Gateway clusters)</p>
</div>
<div class="paragraph">
<p>Inter-cluster replication conflict resolution policies and behaviors.</p>
</div>
<div class="paragraph">
<p><em>Related</em>&#8201;&#8212;&#8201;<a href="../refer/config-properties.html" class="page">Configuration Schema</a> | <a href="../refer/rest-api-admin.html" class="page">Admin REST API</a></p>
</div>
<div class="paragraph">
<p><em>Topic Group</em>&#8201;&#8212;&#8201;Inter-cluster Replication</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sync Gateway&#8217;s inter-cluster replication supports automatic conflict resolution to resolve conflicting document changes (revisions).
It delivers this using a flexible policy-driven mechanism, which automatically detects and resolves document conflicts under replication.</p>
</div>
<div class="paragraph">
<p>A set of conflict resolver policies are available out-of-the-box. They can be easily applied to Sync Gateway replications to give automatic resolution.</p>
</div>
<div class="paragraph">
<p>As soon as the <em>active</em> Sync Gateway database detects a conflict in a replicated document revision, it applies the specified resolver policy. This policy assesses the conflicting revisions and either determines the winning revision or returns an error if it fails while doing so.</p>
</div>
<div class="paragraph">
<p>See: <a href="#resolver-policies">conflict resolver policies</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="automatic-conflict-resolution"><a class="anchor" href="#automatic-conflict-resolution"></a>Automatic Conflict Resolution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When an active Sync Gateway database detects a conflict in replicated document revisions, it calls and applies its configured <a href="#resolver-policies">resolver policy</a> to determine a <em>winning</em> revision.
It will return an error if this process fails.</p>
</div>
<div class="paragraph">
<p>When a passive Sync Gateway database detects a conflict it responds to the active with a <code>409</code> response and rejects the revision. The active Sync Gateway will then apply its specified conflict resolver policy.</p>
</div>
<div class="paragraph">
<p>The default automatic resolution policy always returns a winner determined by the following rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If one revision is a delete (tombstone), that is the winner.</p>
</li>
<li>
<p>If both revisions are deletes then the delete with the longest revision history (most revisions) wins. In short the delete with the highest revision Id wins.</p>
</li>
<li>
<p>If neither revision is a delete then the revision with the longest revision history (most revisions) wins.</p>
</li>
<li>
<p>Configured using: <code>"conflict_resolution_type": "useDefault"</code>.</p>
</li>
</ul>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://www.couchbase.com/products/editions">ENTERPRISE EDITION</a></dt>
<dd>
<p>A <em>custom</em> resolver policy is available.
It provides additional flexibility allowing users to provide their own resolution logic&#8201;&#8212;&#8201;see <a href="#custom-conflict-resolution-ee">Custom Conflict Resolver</a>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resolver-policies"><a class="anchor" href="#resolver-policies"></a>Resolver Policies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Conflict resolution is configurable, in that you can choose to apply one of the out-of-the-box (predefined) conflict resolver policies.</p>
</div>
<div id="predefined-resolver-policies" class="dlist">
<dl>
<dt class="hdlist1">Default</dt>
<dd>
<p>Applies the default policy described in <a href="#automatic-conflict-resolution">Automatic Conflict Resolution</a></p>
</dd>
<dt class="hdlist1">Local Wins</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Always considers the local change the winner.</p>
</li>
<li>
<p>Configured using: <code>"conflict_resolution_type": "localWins"</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Remote Wins</dt>
<dd>
<p>Always considers the remote change the winner.</p>
<div class="ulist">
<ul>
<li>
<p>Configured using: <code>"conflict_resolution_type": "remoteWins"</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-resolution-works"><a class="anchor" href="#how-resolution-works"></a>How Resolution Works</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Pull Replications</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For <em>Pull</em> replications the <em>active</em> Sync Gateway is responsible for detecting and resolving conflicts based on the configured <em>conflict_resolution_type</em> (see configuration item: <a href="../refer/config-properties.html#databases-this_db-replications-conflict_resolution_type" class="page">conflict_resolution_type</a>.</p>
</div>
<div class="paragraph">
<p>This is also how conflicts are handled when Couchbase Lite clients pull down documents to Sync Gateway.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Resolved conflicts are only transferred from active to passive Sync Gateways if a replication is setup between them.</p>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Push Replications</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Passive Sync Gateway</dt>
<dd>
<p>The <em>passive</em> Sync Gateway will automatically detect and reject conflicting revisions being <em>pushed</em> to it.</p>
<div class="paragraph">
<p>Note that conflicts are not resolved.
The revision is rejected and the document returned&#8201;&#8212;&#8201;with a <code>409 Conflict</code>&#8201;&#8212;&#8201;response to the active Sync Gateway.</p>
</div>
</dd>
<dt class="hdlist1">Active Sync Gateway</dt>
<dd>
<p>It is  the responsibility of the active sync Gateway to address rejected revisions in accordance with its specified <em>conflict_resolution_type</em>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>This approach is the same as that adopted when Couchbase Lite clients push documents to Sync Gateway.</p>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-a-policy-to-use"><a class="anchor" href="#configuring-a-policy-to-use"></a>Configuring a Policy to Use</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To invoke automatic conflict resolution, simply specify the required policy in the replication definition.
The specified conflict resolver policy will be applied by the active Sync Gateway whenever a conflict is detected during replication.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Using automatic conflict resolution</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_default"></a>default</p>
</li>
<li>
<p><a id="tabset1_localwins"></a>localWins</p>
</li>
<li>
<p><a id="tabset1_remotewins"></a>remoteWins</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_default">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"databases:"
  // other config as necessary
  "this_db:"
    // other config as necessary
    "sgreplicate_enabled": "true",
    "replications": [
        {
          "replication_id": "replication1",
          "direction": "push_and_pull",
          "continuous": true,
          "filter": "sync_gateway/bychannel",
          "query_params": [
              "channel1",
              "channel2"
          ],
          "conflict_resolution_type": "default",
          // other config as necessary
        }
    ]
// other config as necessary</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_localwins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"databases:"
  // other config as necessary
  "this_db:"
    // other config as necessary
    "sgreplicate_enabled": "true",
    "replications": [
        {
          "replication_id": "replication1",
          "direction": "push_and_pull",
          "continuous": true,
          "filter": "sync_gateway/bychannel",
          "query_params": [
              "channel1",
              "channel2"
          ],
          "conflict_resolution_type": "localWins",
          // other config as necessary
        }
    ]
// other config as necessary</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_remotewins">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"databases:"
  // other config as necessary
  "this_db:"
    // other config as necessary
    "sgreplicate_enabled": "true",
    "replications": [
        {
          "replication_id": "replication1",
          "direction": "push_and_pull",
          "continuous": true,
          "filter": "sync_gateway/bychannel",
          "query_params": [
              "channel1",
              "channel2"
          ],
          "conflict_resolution_type": "remoteWins",
          // other config as necessary
        }
    ]
// other config as necessary</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom-conflict-resolution-ee"><a class="anchor" href="#custom-conflict-resolution-ee"></a>Custom Conflict Resolution [EE]</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.couchbase.com/products/editions">ENTERPRISE EDITION</a></p>
</div>
<div class="paragraph">
<p><em>In this section</em>: <a href="#conflict-resolution-approaches">Conflict Resolution Approaches</a>  |  <a href="#approaches-to-error-handling">Approaches to Error Handling</a>  |  <a href="#conflict-resolver-structure">Conflict Resolver Structure</a></p>
</div>
<div class="paragraph">
<p>Custom conflict resolution is handled by the <em>active</em> Sync Gateway using a user-provided <em>custom conflict resolver</em>. This Javascript function is embedded in the replication configuration.</p>
</div>
<div class="paragraph">
<p>The predefined conflict resolver policies are also available as Javascript functions that you can call from within that <em>custom_conflict_resolver</em> function</p>
</div>
<div class="paragraph">
<p>You can invoke the non-custom built-in resolver policies from within your resolver function. This is useful when you want to apply greater selectivity to the automatic conflict resolution process. For example, you want to apply the <code>remoteWins</code> policy only for a specific type of document - see <a href="#use-policies">Use Policies</a> tab in <a href="#simple-conflict-resolvers">Example 3</a>.</p>
</div>
<div class="sect2">
<h3 id="conflict-resolution-approaches"><a class="anchor" href="#conflict-resolution-approaches"></a>Conflict Resolution Approaches</h3>
<div class="paragraph">
<p>There are two ways to handle conflicts in your custom_conflict_resolver, you can either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Choose a <em>winning</em> revision from among the conflicting revisions (see <a href="#simple-conflict-resolvers">Example 3</a>), or</p>
</li>
<li>
<p>Merge conflicting revision to create a new <em>winning</em> revision; losing revisions are tomb-stoned.</p>
<div class="paragraph">
<p>However, user are cautioned against using complex resolver logic as it can have a significant impact on performance.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="approaches-to-error-handling"><a class="anchor" href="#approaches-to-error-handling"></a>Approaches to Error Handling</h3>
<div class="paragraph">
<p>The custom conflict resolver function should not terminate the replication when it encounters exceptions or errors <em>pull</em> replication.
Instead it should provide sufficient information to aid troubleshooting and recovery.</p>
</div>
<div class="paragraph">
<p>For example, your custom conflict resolver function should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Skip the document causing the issue</p>
</li>
<li>
<p>Log a suitable warning level message.
Include at least the skipped document&#8217;s Id and the sequence Id of the revision in error.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to log files when troubleshooting conflict resolution errors, to identify the document id and revision sequence in error.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Some Error Scenarios and Recommended Resolutions</div>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Unexpected data in the remote document</dt>
<dd>
<p>You should update the remote document to fix the issue.
Doing so will cause replication of the update.</p>
</dd>
<dt class="hdlist1">Unexpected data in the local document</dt>
<dd>
<p>You should update the local document to fix the issue.
This will not trigger a pull-replication.
Do a no-op-update <sup class="footnote" id="_footnote_fn-1">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> of the remote document, which will trigger replication and conflict resolution.</p>
</dd>
<dt class="hdlist1">Fault in conflict resolution javascript function</dt>
<dd>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Fix the Javascript logic and then either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do a <em>no op update</em> <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> of the remote document.
This triggers a pull replication and subsequent conflict resolution.</p>
</li>
<li>
<p>Reset the replication (using <code>_replicationstatus/reset</code> endpoint). Not recommended as it introduces significant duplicate processing in re-syncing previously synced documents.</p>
</li>
</ul>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conflict-resolver-structure"><a class="anchor" href="#conflict-resolver-structure"></a>Conflict Resolver Structure</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">//
function (local, remote) { <i class="conum" data-value="1"></i><b>(1)</b>
	// TODO: Determine winner using built-in or custom policy
	return { <i class="conum" data-value="2"></i><b>(2)</b>
		body: winner.body,
		meta: winner.meta
	}; // Return winning revision
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>Parameters</strong>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">local</dt>
<dd>
<p>This <em>local</em> object encapsulates the body and metadata of the local conflicting document revision being replicated. Its content matches the JSON stored at the local Sync Gateway.</p>
</dd>
<dt class="hdlist1">remote</dt>
<dd>
<p>The <em>remote</em> object, encapsulates the body and metadata of the remote conflicting document revision being replicated. Its content matches the JSON stored at the remote Sync Gateway.</p>
</dd>
</dl>
</div>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>Return object</strong>
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">body</dt>
<dd>
<p>Set the <em>body</em> object of the winning document revision to contain the <em>body</em> content of the JSON body of either the local, or remote, document revisions.</p>
</dd>
<dt class="hdlist1">meta</dt>
<dd>
<p>This is the Metadata of the winning document revision. Set it to the content of the JSON body of either the local, or remote, document metadata.</p>
</dd>
</dl>
</div>
</div>
</div></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sample-conflict-resolvers"><a class="anchor" href="#sample-conflict-resolvers"></a>Sample Conflict Resolvers</h3>
<div id="simple-conflict-resolvers" class="exampleblock">
<div class="title">Example 3. Simple conflict resolvers</div>
<div class="content">
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_use-policies"></a>Use Policies</p>
</li>
<li>
<p><a id="tabset2_nominate-a-winner"></a>Nominate a Winner</p>
</li>
<li>
<p><a id="tabset2_merge-a-winner"></a>Merge a Winner</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_use-policies">
<div class="paragraph">
<p>This example uses the built-in resolver functions to resolve the conflict based-on the document type.</p>
</div>
<div class="paragraph">
<p>So, documents of type <code>a-doc-type-1</code> are always resolved in favor of the remote revision. All other document types are resolved in accordance with the default resolver policy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"replications": [
  {
  "replication_id": "replication1",
  // other config as required
  "conflict_resolution_type": "custom",
  "custom_conflict_resolver": `
    function(conflict) {
      if  (conflict.LocalDocument.type == "a-doctype-1") &amp;&amp;
          (conflict.RemoteDocument.type == "a-doctype-1")
       {
          // Invoke the built in resolver logic for remoteWins
          return remoteWinsPolicy(conflict);
        }
        else {
          // Invoke the built in default resolver logic
          return defaultPolicy(conflict);
        }
    }
    `
// other config as required
  }
]</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_nominate-a-winner">
<div class="paragraph">
<p>This example selects a winner based on relative priorities and builds a return response of its own rather than using either the localWins or remoteWins policy, although it does rely on the default resolver policy as a backstop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"replications": [
  {
    // . . . preceding replication details as required
  },
  {
    "replication_id": "replication2",
    // . . .   other config as required
    "conflict_resolution_type": "custom",
    "custom_conflict_resolver": `
      function(conflict) {
        // Custom conflict resolution policy based on priority
        if (conflict.LocalDocument.body.priority &gt; conflict.RemoteDocument.body.priority) {
          // Choose a local winner
          // Optionally apply application logic to manipulate
          // the local object before returning it as the winner
          return conflict.LocalDocument;
        } else if (local.body.priority &lt; remote.body.priority) {
            // Choose a remote winner
            // Optionally apply application logic to manipulate
            // the remote object before returning it as the winner
          return conflict.RemoteDocument;
          }; //end if
        } //end func()
        // Apply the default policy as a catch all
        return defaultPolicy(conflict);
    }` // end resolver property
  }, // end replication2
  {
    // . . . further replication details as required
  }
]
// . . .   other config as required</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_merge-a-winner">
<div class="paragraph">
<p>This example creates a winner by merging changes from the local and remote documents to create a new document object, which is returned as the winner.</p>
</div>
<div class="paragraph">
<p>If both document.types are non-null and the local document.type is <code>usedefault</code>, the merge path is overridden and the default resolver policy is applied.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"custom_conflict_resolver":`
  function(conflict) {
      if (  (conflict.LocalDocument.type != null) &amp;&amp;
            (conflict.RemoteDocument.type != null) &amp;&amp;
            (conflict.LocalDocument.type == "usedefault"))
      {
          console.log("Will use default policy");
          // Resolve using built-in policy
          return defaultPolicy(conflict);
      }
      else
      {
        // Merge local and remote docs
        var remoteDoc = conflict.RemoteDocument;
        console.log("full remoteDoc doc: "+JSON.stringify(remoteDoc));
        var localDoc = conflict.LocalDocument;
        console.log("full localDoc doc: "+JSON.stringify(localDoc));
        var mergedDoc = extend({}, localDoc, remoteDoc);

        console.log("full merged doc: "+JSON.stringify(mergedDoc));
        // Resolve using this merged doc as the winner
        return mergedDoc;

        function extend(target) {
            var sources = [].slice.call(arguments, 1);
            sources.forEach(function (source) {
                for (var prop in source) {
                    target[prop] = source[prop];
                }
            });
            return target;
        } // end function extend()
      } // end if
  }` // end function()</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 pane__frames cols-3">
<h2 id="related-content"><a class="anchor" href="#related-content"></a>Related Content</h2>
<div class="sectionbody">
<div class="ulist">
<div class="title">Learn more ...</div>
<ul>
<li>
<p></p>
</li>
<li>
<p><a href="icr-overview.html#introduction" class="page">Introducing Inter-Cluster Replication</a></p>
</li>
<li>
<p><a href="icr-delta-sync.html" class="page">Delta-sync</a></p>
</li>
<li>
<p><a href="icr-conflict-resolution.html" class="page">Conflict Resolution</a></p>
</li>
<li>
<p><a href="icr-replication-types.html" class="page">Replication Types</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference material ...</div>
<ul>
<li>
<p><a href="../refer/config-properties.html" class="page">Configuration Schema</a></p>
</li>
<li>
<p><a href="../refer/rest-api-public.html" class="page">Public REST API</a></p>
</li>
<li>
<p><a href="../refer/rest-api-admin.html" class="page">Admin REST API</a></p>
</li>
<li>
<p><a href="../advance/adv-rest-api-client.html" class="page">Use the REST API</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Additional Resources ...</div>
<ul>
<li>
<p><a href="https://forums.couchbase.com/c/mobile/14">Forum</a>  <strong>|</strong>  <a href="https://blog.couchbase.com/">Blog</a>   <strong>|</strong>  <a href="https://docs.couchbase.com/tutorials/index.html">Tutorials</a></p>
</li>
<li>
<p>Conflict Related Blogs: <a href="https://blog.couchbase.com/document-conflicts-couchbase-mobile/">Document Conflicts and Automatic Conflict Resolution</a>   <strong>|</strong>  <a href="https://blog.couchbase.com/conflict-resolution-couchbase-mobile/">Demystifying Conflict Resolution</a>  <strong>|</strong>  <a href="https://blog.couchbase.com/tag/conflict-resolution/">Conflict Resolution (category)</a></p>
</li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. No-op update&#8201;&#8212;&#8201;refers to a change to the document body that has no impact on the app logic but will trigger an import by the Sync Gateway. One option could be to include a property used specifically for this purpose (i.e. a counter that can be incremented in response to conflict resolver errors).
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase_logo_black.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2020 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
